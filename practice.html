<!-- practice.html - Quiz player page for EduTech -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduTech | Practice Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-900 to-blue-500 text-white min-h-screen p-6">
  <div class="max-w-3xl mx-auto bg-white text-black p-6 rounded-xl shadow-xl">
    <h1 class="text-2xl font-bold mb-4" id="quiz-title">Loading...</h1>
    
    <div id="quiz-box" class="space-y-6"></div>

    <div class="flex justify-between mt-4">
      <button id="prev-btn" onclick="prevQuestion()" class="bg-gray-400 text-white px-4 py-2 rounded hidden">Previous</button>
      <button id="next-btn" onclick="nextQuestion()" class="bg-blue-700 text-white px-6 py-2 rounded">Next</button>
      <button id="submit-btn" onclick="submitQuiz()" class="bg-green-600 text-white px-6 py-2 rounded hidden">Submit Quiz</button>
    </div>
  </div>  

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDci6GAa0SPYWvpQa6s0ywkN4pLpcckSO0",
      authDomain: "edutech002-e674b.firebaseapp.com",
      projectId: "edutech002-e674b",
      storageBucket: "edutech002-e674b.firebasestorage.app",
      messagingSenderId: "634874984437",
      appId: "1:634874984437:web:8e2082e99d0bfa1061d2bc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    let quizId = localStorage.getItem("quiz_id");
    if (!quizId) location.href = "dashboard.html";
    document.getElementById("quiz-title").textContent = quizId.replace(/_/g, ' ');

    const quizBox = document.getElementById("quiz-box");

    let quizData = [];
    let userUID = null;
    let currentIndex = 0;
    window.answers = {};   // ✅ answers global

    // ✅ Auth and Quiz Data Load
    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = 'index.html';
      userUID = user.uid;
      const docSnap = await getDoc(doc(db, "questions", quizId));
      if (!docSnap.exists()) return alert("Quiz not found");

      quizData = docSnap.data().questions || [];
      if (quizData.length === 0) {
        quizBox.innerHTML = "<p class='text-red-500'>No questions found in this quiz.</p>";
      } else {
        renderQuestion();   // ✅ show first question
      }
    });

    // ✅ Render One Question
    function renderQuestion() {
      const q = quizData[currentIndex];
      const options = q.options.map(opt => `
        <label class='block'>
          <input type='radio' name='q${currentIndex}' value='${opt}'
            ${answers[currentIndex] === opt ? "checked" : ""}>
          ${opt}
        </label>
      `).join('');

      quizBox.innerHTML = `
        <div class='bg-gray-100 p-4 rounded'>
          <h3 class='font-semibold mb-2'>${currentIndex + 1}. ${q.q}</h3>
          ${options}
        </div>
      `;

      // ✅ Save selected answer
      document.querySelectorAll(`input[name='q${currentIndex}']`).forEach(input => {
        input.addEventListener("change", (e) => {
          answers[currentIndex] = e.target.value;
        });
      });

      // ✅ Button visibility
      document.getElementById("prev-btn").classList.toggle("hidden", currentIndex === 0);
      document.getElementById("next-btn").classList.toggle("hidden", currentIndex === quizData.length - 1);
      document.getElementById("submit-btn").classList.toggle("hidden", currentIndex !== quizData.length - 1);
    }

    // ✅ Navigation
    window.nextQuestion = () => {
      if (currentIndex < quizData.length - 1) {
        currentIndex++;
        renderQuestion();
      }
    };

    window.prevQuestion = () => {
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion();
      }
    };

    // ✅ Submit Quiz with Multiple Attempts + Answers
    window.submitQuiz = async () => {
      let score = 0;
      quizData.forEach((q, i) => {
        if (answers[i] && answers[i] === q.answer) {
          score++;
        }
      });

      const xpEarned = score * 5;
      const userRef = doc(db, "users", userUID);
      const userSnap = await getDoc(userRef);
      const currentXP = userSnap.data().xp || 0;

     await updateDoc(userRef, {
  xp: currentXP + xpEarned,
  [`history.${quizId}`]: arrayUnion({
    score,
    total: quizData.length,
    timestamp: new Date().toISOString(),
    answers: quizData.map((q, i) => {
      const selected = document.querySelector(`input[name='q${i}']:checked`);
      return selected ? selected.value : "Not Answered";
    })
  })
});

      alert(`✅ You scored ${score}/${quizData.length} and earned ${xpEarned} XP!`);
      location.href = "dashboard.html";
    };
  </script>
</body>
</html>

<!-- practice.html - Quiz player page for EduTech -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduTech | Practice Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-900 to-blue-500 text-white min-h-screen p-6">
  <div class="max-w-3xl mx-auto bg-white text-black p-6 rounded-xl shadow-xl relative">
    <h1 class="text-2xl font-bold mb-4" id="quiz-title">Loading...</h1>
    
    <!-- Loading Spinner -->
    <div id="loading" class="absolute inset-0 bg-white/80 flex justify-center items-center z-50">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700"></div>
    </div>

    <div id="quiz-box" class="space-y-6"></div>

    <div class="flex justify-between mt-4">
      <button id="prev-btn" onclick="prevQuestion()" class="bg-gray-400 text-white px-4 py-2 rounded hidden">Previous</button>
      <button id="next-btn" onclick="nextQuestion()" class="bg-blue-700 text-white px-6 py-2 rounded">Next</button>
      <button id="submit-btn" onclick="submitQuiz()" class="bg-green-600 text-white px-6 py-2 rounded hidden">Submit Quiz</button>
    </div>
  </div>  

  <!-- Toast for answer saved -->
  <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded opacity-0 transition-opacity duration-500">
    Answer saved!
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDci6GAa0SPYWvpQa6s0ywkN4pLpcckSO0",
      authDomain: "edutech002-e674b.firebaseapp.com",
      projectId: "edutech002-e674b",
      storageBucket: "edutech002-e674b.firebasestorage.app",
      messagingSenderId: "634874984437",
      appId: "1:634874984437:web:8e2082e99d0bfa1061d2bc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    let quizId = localStorage.getItem("quiz_id");
    if (!quizId) location.href = "dashboard.html";
    document.getElementById("quiz-title").textContent = quizId.replace(/_/g, ' ');

    const quizBox = document.getElementById("quiz-box");
    const loadingEl = document.getElementById("loading");
    const toastEl = document.getElementById("toast");

    let quizData = [];
    let userUID = null;
    let currentIndex = 0;
    window.answers = {}; // global answers

    function showToast() {
      toastEl.classList.remove("opacity-0");
      setTimeout(() => toastEl.classList.add("opacity-0"), 1000);
    }

    // ✅ Auth and Quiz Data Load
    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = 'index.html';
      userUID = user.uid;

      try {
        const docSnap = await getDoc(doc(db, "questions", quizId));
        if (!docSnap.exists()) throw new Error("Quiz not found");
        quizData = docSnap.data().questions || [];

        if (quizData.length === 0) {
          quizBox.innerHTML = "<p class='text-red-500'>No questions found in this quiz.</p>";
        } else {
          renderQuestion();
        }
      } catch (err) {
        alert(err.message);
      } finally {
        loadingEl.style.display = "none"; // hide spinner
      }
    });

    // ✅ Render One Question
    function renderQuestion() {
      const q = quizData[currentIndex];
      const options = q.options.map(opt => `
        <label class='block'>
          <input type='radio' name='q${currentIndex}' value='${opt}'
            ${answers[currentIndex] === opt ? "checked" : ""}>
          ${opt}
        </label>
      `).join('');

      quizBox.innerHTML = `
        <div class='bg-gray-100 p-4 rounded'>
          <h3 class='font-semibold mb-2'>${currentIndex + 1}. ${q.q}</h3>
          ${options}
        </div>
      `;

      // ✅ Save selected answer automatically
      document.querySelectorAll(`input[name='q${currentIndex}']`).forEach(input => {
        input.addEventListener("change", (e) => {
          answers[currentIndex] = e.target.value;
          showToast(); // show "Answer saved"
        });
      });

      // ✅ Button visibility
      document.getElementById("prev-btn").classList.toggle("hidden", currentIndex === 0);
      document.getElementById("next-btn").classList.toggle("hidden", currentIndex === quizData.length - 1);
      document.getElementById("submit-btn").classList.toggle("hidden", currentIndex !== quizData.length - 1);
    }

    // ✅ Navigation
    window.nextQuestion = () => {
      if (currentIndex < quizData.length - 1) {
        currentIndex++;
        renderQuestion();
      }
    };

    window.prevQuestion = () => {
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion();
      }
    };

    // ✅ Submit Quiz with all answers saved
    window.submitQuiz = async () => {
      loadingEl.style.display = "flex"; // show spinner while submitting

      let score = 0;
      quizData.forEach((q, i) => {
        if (answers[i] && answers[i] === q.answer) score++;
      });

      const xpEarned = score * 5;
      const userRef = doc(db, "users", userUID);
      const userSnap = await getDoc(userRef);
      const currentXP = userSnap.data().xp || 0;

      await updateDoc(userRef, {
        xp: currentXP + xpEarned,
        [`history.${quizId}`]: arrayUnion({
          score,
          total: quizData.length,
          timestamp: new Date().toISOString(),
          answers: quizData.map((q, i) => answers[i] || "Not Answered")
        })
      });

      loadingEl.style.display = "none";
      alert(`✅ You scored ${score}/${quizData.length} and earned ${xpEarned} XP!`);
      location.href = "dashboard.html";
    };
  </script>
</body>
</html>
